# Лабораторная работа №5. Работа с базой данных

## Цель работы

Я успешно освоила архитектуру с единой точкой входа, подключила шаблоны для визуализации страниц, а также реализовала переход от хранения данных в файле к использованию базы данных MySQL.

## Условия

Я продолжила разработку проекта, начатого в предыдущей лабораторной работе: реализовала архитектуру с единой точкой входа через файл `index.php`, настроила базовую систему шаблонов с использованием `layout.php` и отдельных представлений для разных страниц, а также перенесла логику работы с рецептами из файловой системы в базу данных MySQL.

### Инструкция по запуску приложения

1. Установите и запустите локальный сервер.
- Убедитесь, что у вас установлен и запущен локальный веб-сервер с поддержкой PHP и MySQL, например: XAMPP

2. Создайте базу данных

- Откройте phpMyAdmin или другой интерфейс для работы с MySQL.

- Создайте базу данных.

- Импортируйте структуру таблицы, указав соответствующие поля (если файл с SQL-структурой есть — приложите его).

3. Настройте подключение к базе данных

- Откройте файл config/db.php (или .env, если используется).

- Убедитесь, что указаны правильные параметры: имя базы данных, имя пользователя, пароль и хост.

3. Запустите приложение

- Поместите проект в папку htdocs (для XAMPP) или в корневую директорию веб-сервера.

- Перейдите в браузере по адресу:

`http://localhost/recipe-book/public/`
Приложение откроется на главной странице.

### Задание 1. Подготовка среды

1. Я установила и настроила локальный сервер MySQL с помощью `XAMPP`, обеспечив корректную работу базы данных для проекта.
2. Создала базу данных под названием `furniture_store`.
3. Создала таблицу `furniture_products` со следующей структурой:

   ```sql
      CREATE TABLE furniture_products (
      id INT AUTO_INCREMENT PRIMARY KEY,
      name VARCHAR(255) NOT NULL,
      category_id INT NOT NULL,
      description TEXT,
      tags TEXT,
      steps TEXT,
      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (category_id) REFERENCES categories(id) ON DELETE CASCADE
    );
   ```

4. Создала таблицу `categories` со следующей структурой:

   ```sql
      CREATE TABLE categories (
      id INT AUTO_INCREMENT PRIMARY KEY,
      name VARCHAR(100) NOT NULL UNIQUE,
      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
   );
   ```

### Задание 2. Архитектура и шаблонизация

1. В корневой папке `public/` я создала файл `index.php`, который служит основной точкой входа в приложение.
2. Я настроила маршрутизацию, обрабатывающую запросы к различным страницам проекта.
3. Создала  файл `templates/layout.php`,  который используется как базовый шаблон для всех страниц.
4. Также были разработаны шаблоны для следующих страниц:
   1. `index` — отображение всех продуктов;
   2. `create` — форма добавления продукта;
   3. `recipe` — страница с подробной информацией о продукте.

Фактическая структура моего проекта выглядит следующим образом:

```
htdocs/
├── public/
│   └── index.php
├── src/
│   ├── handlers/
│   │   ├── product/
│   │   │   ├── create.php
│   │   │   ├── edit.php
│   │   │   └── delete.php
│   ├── db.php
│   ├── helpers.php
├── config/
│   └── db.php
├── templates/
│   ├── layout.php
│   ├── index.php
│   └── product/
│       ├── create.php
│       ├── edit.php
│       └── show.php
└── README.md
```

### Задание 3. Подключение к базе данных

1. В файле `src/db.php` я реализовала функцию подключения к базе данных с использованием PDO.
2. Параметры подключения вынесены в файл `config/db.php`.
   1. В качестве дополнительного задания я также настроила использование файла`.env` для хранения подключения к базе данных.
3. Функция подключения возвращает экземпляр `PDO`, настроенный на выбрасывание исключений (`PDO::ERRMODE_EXCEPTION`).

### Задание 3. Реализация CRUD-функциональности

1. Я реализовала обработчики для выполнения следующих операций:
   1. Добавление продукта (`handlers/product/create.php`);
   2. Редактирование продукта (`handlers/product/edit.php`);
   3. Удаление продукта (`handlers/product/delete.php`).
2. Все данные теперь сохраняются и извлекаются исключительно из базы данных.
3. Также была реализована проверка и валидация данных на стороне сервера.

### Задание 4. Защита от SQL-инъекций

1. Для защиты от SQL-инъекций я использовала подготовленные выражения при выполнении всех SQL-запросов.
2. Все входные данные валидируются и экранируются перед взаимодействием с базой данных.
3. Я также продемонстрировала пример потенциальной SQL-инъекции и объяснила, как реализованные меры предотвращают подобные атаки.

### Задание 5. _Дополнительное задание_. Пагинация

1. Я реализовала пагинацию с использованием SQL-запросов LIMIT и OFFSET, отображая по 5 продуктов на одной странице. Поддерживается переход по страницам (`page=2`, `page=3` и т.д.).

## Документация кода

Весь код проекта снабжён корректной документацией в формате PHPDoc. Каждая функция и метод описаны с указанием входных параметров, возвращаемых значений и выполняемого функционала. Комментарии написаны ясно и информативно, что облегчает понимание кода другим разработчикам.

## Контрольные вопросы

1. Какие преимущества даёт использование единой точки входа в веб-приложении? <br>
Использование единой точки входа (например, `index.php`) позволяет централизовать обработку всех входящих запросов. Это упрощает маршрутизацию, улучшает контроль доступа и безопасности, а также делает структуру приложения более организованной и масштабируемой. Все настройки, подключения и загрузки зависимостей можно выполнять в одном месте, избегая дублирования кода.
2. Какие преимущества даёт использование шаблонов?<br>
Шаблоны позволяют отделить логику от представления, что делает код более читаемым и поддерживаемым. Изменения в оформлении сайта можно внести в одном шаблоне без необходимости редактировать каждую страницу. Это ускоряет разработку, снижает количество дублирующегося кода и облегчает повторное использование компонентов интерфейса.
3. Какие преимущества даёт хранение данных в базе по сравнению с хранением в файлах?<br>
Хранение данных в базе данных (например, MySQL) обеспечивает более высокую производительность при работе с большим объёмом информации, позволяет легко выполнять сортировку, фильтрацию и поиск по данным. Базы данных поддерживают транзакции, ограничения, связи между таблицами и безопасный многопользовательский доступ. Работа с файлами менее гибкая и менее надёжная в масштабируемых проектах.
4. Что такое SQL-инъекция? Придумайте пример SQL-инъекции и объясните, как её предотвратить.<br>
SQL-инъекция — это тип уязвимости, при котором злоумышленник вставляет вредоносный SQL-код в пользовательский ввод, чтобы изменить выполнение запроса к базе данных.
Пример уязвимого кода:
```php
    $username = $_GET['username'];
    $query = "SELECT * FROM users WHERE username = '$username'";
```
Если пользователь введёт в адресной строке:
```php
    ?username=' OR '1'='1,
```
то итоговый SQL-запрос станет:
```sql
    SELECT * FROM users WHERE username = '' OR '1'='1'
```
Этот запрос вернёт все записи из таблицы, нарушая безопасность.

Как предотвратить:
Использовать подготовленные выражения (prepared statements), например с PDO:
```php
    $stmt = $pdo->prepare("SELECT * FROM users WHERE username = :username");
    $stmt->execute(['username' => $username]);
```
В этом случае пользовательский ввод обрабатывается безопасно, и SQL-инъекция становится невозможной.